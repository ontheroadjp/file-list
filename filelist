#!/bin/bash

SCRIPT_FILE_NAME=$(basename $0)
SCRIPT_NAME=${SCRIPT_FILE_NAME%.*}
SELF=$(cd $(dirname $0); pwd)
VERSION="1.2.0"
LOGGING=false
SEPARATER='---------------------------'

function _usage() {
    echo "Usage: ${SCRIPT_NAME} [OPTIONS] [DIR PATH]"
    echo "  This script outputs a list of files in the specified directory."
    echo
    echo "Options:"
    echo "  -h, --help                     Show help."
    echo "  -v, --version                  Show script version."
    echo "  -e, --extension val            Limit the output file to the extension of siblings."
    echo "  -d, --delimiter val            Delimiter at output."
#    echo "  -u, --unused-char              Display unused charactor in file list."
#    echo "  -b, --long-b [ARG]             sample option: either with or without argument."
#    echo "  -c, --long-c                   sample option: have no argument."
#    echo "  -, --                          after this, all value will be argument(s)."
    echo "      --dotfile                  Also outputs a dot file."
    echo "  -a                             Output with absolute path."
    echo "  -c                             Show the number of files."
#    echo "  -p                             sample flag option."
    echo "      --verbose                  Print various logging information"
    echo
    exit 1
}

function _log() {
    ${LOGGING} && echo "$@" || return 0
}

function _err() {
    echo "${SCRIPT_NAME}: $1" && exit ${2:-1}
}

function _args_count() {
    echo ${#ARG_VALUES[@]}
}

function _is_exist() {
    [ -f $1 ] || [ -d $1 ] || [[ $(type $1) ]]
}

function _verbose() {
    _log "DIR: ${DIR}"
    _log "EXT: ${EXT[@]}"
    _log "IS_ABSOLUTE_PATH: ${IS_ABSOLUTE_PATH}"
    _log "IS_SHOW_DOT_FILE: ${IS_SHOW_DOT_FILE}"
    _log "DELIMITER: ${DELIMITER}"
#    _log "SHOW_UNUSED_CHAR: ${SHOW_UNUSED_CHAR}"
    _log "IS_COUNT: ${IS_COUNT}"
    _log "${SEPARATER}"
}

DIR=''
EXT=()
IS_ABSOLUTE_PATH=false
IS_SHOW_DOT_FILE=false
#SHOW_UNUSED_CHAR=false
DELIMITER='\n'
IS_COUNT=false

#function _unused_char() {
#    local chars='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'
#    local letters=($(echo ${chars} | fold -w 1 | tr '\n' ' '))
#    IFS=" "
#    for l in ${letters[@]}; do
#        if [[ ! "$1" =~ "$l" ]]; then
#            echo $l
#            return
#        fi
#    done
#    echo 'nothing'
#}

function _main() {
    local results=()
    while read -r file; do

        local is_print_ok=true
        local is_dot_file=false

        file=$(echo "${file}" | sed 's:^\./::')

        local filename=$(basename ${file})
        if [ ${filename:0:1} == '.' ]; then
            ${IS_SHOW_DOT_FILE} || {
                continue
            }
        fi

        [ ! -z ${EXT} ] && {
            if [[ " ${EXT[@]} " =~ " ${file##*.} " ]]; then
                is_print_ok=true
            else
                is_print_ok=false
            fi
        }

        ${is_print_ok} &&  {
            ${IS_ABSOLUTE_PATH} && {
                results+=("${SELF}/${file}")
            } || {
                results+=("${file}")
            }
        }
    done < <(find "${DIR}" -type f -mindepth 1 -maxdepth 1)

#    ${SHOW_UNUSED_CHAR} && {
#        ( IFS="\n"; echo "unused char: $(_unused_char $(echo ${results[*]}))" )
#    }

    ${IS_COUNT} && echo ${#results[@]} && exit 0

    [ "${DELIMITER}" = '\n' ] && {
        (IFS=$'\n'; echo "${results[*]}")
    } || {
        #(IFS="${DELIMITER}"; echo "${results[*]}")
        ( IFS=$'\n'
            for i in ${results[@]}; do
                local str+="${i}${DELIMITER}"
            done
            echo $(echo ${str} | sed "s/${DELIMITER}$//")
        )
    }
}

# -------------------------------------------------------------
# Arguments and Options
# -------------------------------------------------------------

ARG_VALUES=()

function _analyse_args_and_options() {
    while (( $# > 0 ))
    do
        case $1 in
            -h | --help)
                _usage
                exit 1
                ;;
            -v | --version)
                echo ${SCRIPT_NAME} v${VERSION}
                exit 0
                ;;
            --verbose)
                LOGGING=true
                shift
                ;;

            # Must have argument
            -e | --extention)
                if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                    _err "-e option requires a value."
                fi
                EXT+=($2)
                shift 2
                ;;

            # Must have argument
            -d | --delimiter)
                if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
                    _err "-d option requires a value."
                fi
                DELIMITER=$2
                shift 2
                ;;

#            # Either with or without argument is possible
#            -b | --long-b)
#                set +u
#                if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
#                    shift
#                else
#                    SAMPLE_OPTION_B=$2
#                    shift 2
#                fi
#                set -u
#                ;;
            -u | --unused-char)                  # no argument
                SHOW_UNUSED_CHAR=true
                shift
                ;;

            # after this all args include '-xx', will treat arg value
            -- | -)
                shift
                ARG_VALUES+=( "$@" )
                break
                ;;

            # for true or false flags, no argument
            --*)
                if [[ "$1" =~ 'dotfile' ]]; then
                    IS_SHOW_DOT_FILE=true
                fi
                shift
                ;;

            # for true or false flags, no argument
            -*)
                if [[ "$1" =~ 'a' ]]; then
                    IS_ABSOLUTE_PATH=true
                fi
                if [[ "$1" =~ 'c' ]]; then
                    IS_COUNT=true
                fi
                shift
                ;;

            # for arguments
            *)
                ARG_VALUES+=("$1")
                shift
                ;;
        esac
    done
}

function _set_variables() {
    DIR=${ARG_VALUES[0]:=.}
    return 0
}

function _verify_variables() {
    local ng=('^' '*' '-' '\' '/' '[' ']')
    if [[ "${ng[@]}" =~ "${DELIMITER}" ]]; then
        _err "bad delimiter"
    fi

    [ ! -d ${DIR} ] && _err "No such directory"
    return 0
}

# -------------------------------------------------------------
# Main Routine
# -------------------------------------------------------------
_analyse_args_and_options $@ && {
    _set_variables && _verify_variables && {
        _verbose
        _log 'start main process..' && _log "${SEPARATER}"
        _main
    }
}

exit 0
